# Copyright 2021 iLogtail Authors
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: E2E Test

on:
  pull_request:
    paths-ignore:
      - "docs/**"
      - "example_config/**"
      - "docker/**"
      - "k8s_template/**"
      - "changes/**"
      - "licenses/**"
      - "CHANGELOG.md"
  push:
    branches:
      - main
      - 1.*
      - 2.*
jobs:
  # 生成E2E测试用例列表
  GenerateE2ETestCasesList:
    runs-on: ubuntu-latest
    outputs:
      cases: ${{ steps.discover.outputs.cases }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Discover Test Cases
        id: discover
        run: |
          # 使用JSON格式输出用例列表
          cases=($(find test/e2e/test_cases -mindepth 1 -maxdepth 1 -type d -printf "%f\n"))
          # 检查是否找到用例
          if [ ${#cases[@]} -eq 0 ]; then
            echo "Error: No test cases found"
            exit 1
          fi
          # 转换为JSON数组格式
          json="["
          for i in "${!cases[@]}"; do
            json+="\"${cases[$i]}\""
            if [ $i -lt $((${#cases[@]}-1)) ]; then
              json+=","
            fi
          done
          json+="]"
          # 输出JSON到文件和控制台
          echo "$json" > cases.json
          cat cases.json
          echo "cases=$json" >> $GITHUB_OUTPUT

  # 生成e2e镜像
  GenerateE2ETestImage:
    runs-on: arc-runner-set-ilogtail
    timeout-minutes: 60
    permissions:
      packages: write
    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Set custom submodule URL and fetch
        run: |
          SUBMODULE_PATH="core/_thirdparty/coolbpf"
          git config submodule.$SUBMODULE_PATH.url "https://github.com/aliyun/coolbpf.git"
          git submodule update --init
          cd $SUBMODULE_PATH
          echo "Current commit: $(git rev-parse HEAD)"

      - name: Build Image
        run: |
          docker build \
            --tag aliyun/loongcollector:0.0.1 \
            --file ./docker/Dockerfile_edge_linux \
            --build-arg VERSION=0.0.1 \
            --build-arg BUILD_LOGTAIL_UT=OFF \
            --build-arg ENABLE_COMPATIBLE_MODE=ON \
            --build-arg ENABLE_STATIC_LINK_CRT=ON \
            --build-arg WITHOUTGDB=ON \
            --build-arg WITHSPL=ON \
            --build-arg MAKE_JOBS=16 \
            --build-arg HOST_OS=Linux \
            .

      - name: Export Image to Tar
        run: docker save -o image.tar aliyun/loongcollector:0.0.1

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: loongcollector-image
          path: image.tar

  # E2E测试
  E2E:
    runs-on: ubuntu-latest
    needs: 
      - GenerateE2ETestCasesList
      - GenerateE2ETestImage
    strategy:
      matrix:
        test_case: ${{ fromJson(needs.GenerateE2ETestCasesList.outputs.cases) }}
      fail-fast: false
    timeout-minutes: 60
    steps:
      - name: Set up Go 1.19
        uses: actions/setup-go@v4
        with:
          go-version: 1.19

      - name: Check out code
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Update Docker-compose to v2
        run: |
          sudo curl -SL https://github.com/docker/compose/releases/download/v2.7.0/docker-compose-linux-x86_64 -o /usr/local/bin/docker-compose
          sudo chmod +x /usr/local/bin/docker-compose

      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: loongcollector-image

      - name: Import Image from Tar
        run: docker load -i ./image.tar

      - name: Check Disk Space and Memory Before Test
        run: |
          echo "========================================="
          echo "Disk Space Information"
          echo "========================================="
          df -h
          echo ""
          echo "Disk Usage Summary:"
          df -h / | tail -n 1
          echo ""
          echo "Available disk space:"
          df -h / | awk 'NR==2 {print "Total: "$2", Used: "$3", Available: "$4", Use%: "$5}'
          echo "========================================="
          echo ""
          echo "========================================="
          echo "Memory Information"
          echo "========================================="
          free -h
          echo ""
          echo "Memory Usage Summary:"
          free -h | awk 'NR==2 {print "Total: "$2", Used: "$3", Available: "$7}'
          echo "========================================="

      - name: E2E Behavior Test Case ${{ matrix.test_case }}
        env:
          TEST_CASE: ${{ matrix.test_case }}
        run: |
          # Start background monitor for Doris
          if [ "$TEST_CASE" = "flusher_doris" ]; then
            (
              # Wait for doris container to be created
              for j in {1..60}; do
                docker ps -a | grep -q doris && break
                sleep 1
              done
              
              echo "[DIAGNOSTIC] Doris container found, starting monitoring..."
              
              # Monitor doris startup
              for i in {1..36}; do
                RUNNER_DISK=$(df -h / | awk 'NR==2 {print $4" avail"}')
                RUNNER_MEM=$(free -h | awk 'NR==2 {print $7" avail"}')
                echo "[DIAGNOSTIC-$i] $(date) | Runner Disk: $RUNNER_DISK | Runner Mem: $RUNNER_MEM"
                
                # Container status
                CONTAINER_STATUS=$(docker inspect --format='{{.State.Status}}' doris 2>/dev/null || echo "unknown")
                HEALTH=$(docker inspect --format='{{.State.Health.Status}}' doris 2>/dev/null || echo "unknown")
                EXIT_CODE=$(docker inspect --format='{{.State.ExitCode}}' doris 2>/dev/null || echo "N/A")
                echo "[DIAGNOSTIC-$i] Container: $CONTAINER_STATUS | Health: $HEALTH | ExitCode: $EXIT_CODE"
                
                if [ "$HEALTH" = "healthy" ]; then
                  echo "[DIAGNOSTIC-$i] Doris is healthy, monitoring complete"
                  exit 0
                fi
                
                # If container exited, show logs immediately
                if [ "$CONTAINER_STATUS" = "exited" ]; then
                  echo "[DIAGNOSTIC-$i] Container exited! Showing last 100 lines of logs:"
                  docker logs doris 2>&1 | tail -100 | sed "s/^/[CONTAINER-LOG] /"
                  echo "[DIAGNOSTIC-$i] Showing container resource limits:"
                  docker inspect doris | grep -A 20 "Memory\|ShmSize\|Ulimits" || echo "Cannot get resource info"
                  sleep 10
                  continue
                fi
                
                # Try to get disk and memory info from container
                if docker exec doris df -h / 2>&1 | head -2; then
                  docker exec doris free -h 2>&1 | head -2 || echo "[DIAGNOSTIC-$i] Cannot get container memory info"
                else
                  echo "[DIAGNOSTIC-$i] Cannot exec in container yet..."
                fi
                
                sleep 10
              done
              
              echo "[DIAGNOSTIC] Monitoring timeout reached, showing final logs:"
              docker logs doris 2>&1 | tail -200 | sed "s/^/[FINAL-LOG] /"
            ) &
            echo $! > /tmp/doris_monitor.pid
          fi
          
          ./scripts/e2e.sh e2e
          
          [ -f /tmp/doris_monitor.pid ] && kill $(cat /tmp/doris_monitor.pid) 2>/dev/null || true

  actions-timeline:
    needs: [E2E]
    runs-on: ubuntu-latest
    permissions:
      actions: read
    steps:
      - uses: Kesin11/actions-timeline@v2
